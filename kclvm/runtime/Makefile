default:
	make gen-api-spec
	cargo test

gen-api-spec:
	mkdir -p target

	cargo clean -q

	kclvm_RUNTIME_GEN_API_SPEC= cargo build > ./src/_kclvm_api_spec.rs.tmp

	echo "// Copyright 2022 The KCL Authors. All rights reserved.\n" > ./src/_kclvm_api_spec.rs
	echo "// Auto generated by <make gen-api-spec> command, DONOT EDIT!!!\n" >> ./src/_kclvm_api_spec.rs
	cat ./src/_kclvm_api_spec.rs.tmp >> ./src/_kclvm_api_spec.rs
	rm  ./src/_kclvm_api_spec.rs.tmp

	make -C ./tools/kclvm-runtime-gen-api

	cargo fmt

dev:
	cargo build
	cargo run --bin hello-llvm
	llvm-dis a.out.bc

	# Rust can't re-export from a linked C library (unless you rename) when compiled as a cdylib.
	# https://marcopolo.io/code/from-c-to-rust-to-c/
	# https://github.com/rust-lang/rfcs/issues/2771

	clang++ -stdlib=libc++ -std=c++14 -Wno-override-module -o a.out.exe a.out.bc ./target/debug/libkclvm.a
	#clang++ -Wno-override-module -o a.out.exe a.out.bc ./target/debug/libkclvm.dylib
	./a.out.exe

lib:
	cargo build
	#nm -gU ./target/debug/libkclvm.dylib
	nm -gU ./target/debug/libkclvm.a

ll:
	# target/debug/deps/kclvm.ll

	# cargo build
	# cargo rustc --lib -- --emit=llvm-ir
	# cargo rustc --lib -- --emit=llvm-bc
	# cp target/debug/deps/kclvm.ll target/kclvm-debug.ll
	# cp target/debug/deps/kclvm.bc target/kclvm-debug.bc

	# https://stackoverflow.com/questions/69042049/rust-including-dependenies-in-llvm-bitcode

	RUSTFLAGS="--emit=llvm-bc" cargo build
	llvm-link target/debug/deps/*.bc > target/kclvm-debug.bc
	llvm-dis target/kclvm-debug.bc

ll-release:
	RUSTFLAGS="--emit=llvm-bc" cargo build --release
	llvm-link target/release/deps/*.bc > target/kclvm-release.bc
	llvm-dis target/kclvm-release.bc

ll-wasm:
	RUSTFLAGS="--emit=llvm-bc" cargo build --release --target wasm32-unknown-unknown
	llvm-link target/wasm32-unknown-unknown/release/deps/*.bc > target/kclvm-wasm.bc
	llvm-dis target/kclvm-wasm.bc

fmt:
	cargo fmt

test:
	cargo test

# Only for linux, run it in docker
coverage:
	cargo install cargo-tarpaulin
	cargo tarpaulin -v

lint:
	cargo clippy

clean:
	-rm -rf target
	-rm a.out
